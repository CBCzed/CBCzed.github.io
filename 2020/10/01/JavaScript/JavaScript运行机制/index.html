<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="导读本文主要讲述 JS 运行机制的相关知识点，会从以下几个点分析：  首先了解进程和线程的概念 浏览器有哪些进程，以 chrome 为例子；主要会讲述渲染进程的相关知识点； 通过对 JS 引擎调用栈、宿主环境及事件循环 Event Loop 来讲述 JS的运行机制；">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript运行机制">
<meta property="og:url" content="http://yoursite.com/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="JavaScript修炼">
<meta property="og:description" content="导读本文主要讲述 JS 运行机制的相关知识点，会从以下几个点分析：  首先了解进程和线程的概念 浏览器有哪些进程，以 chrome 为例子；主要会讲述渲染进程的相关知识点； 通过对 JS 引擎调用栈、宿主环境及事件循环 Event Loop 来讲述 JS的运行机制；">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/JavaScript/call_stack_demo.png">
<meta property="og:image" content="http://yoursite.com/images/JavaScript/execute_flow_chart.png">
<meta property="og:image" content="http://yoursite.com/images/JavaScript/execute.png">
<meta property="og:image" content="http://yoursite.com/images/JavaScript/macro-micro.png">
<meta property="og:image" content="http://yoursite.com/images/JavaScript/node_event_loop.png">
<meta property="article:published_time" content="2020-10-01T14:32:50.000Z">
<meta property="article:modified_time" content="2020-10-20T15:43:06.316Z">
<meta property="article:author" content="zed">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/JavaScript/call_stack_demo.png">

<link rel="canonical" href="http://yoursite.com/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>JavaScript运行机制 | JavaScript修炼</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JavaScript修炼</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="zed">
      <meta itemprop="description" content="欲望提升热忱，毅力磨平高山">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JavaScript修炼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JavaScript运行机制
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-01 22:32:50" itemprop="dateCreated datePublished" datetime="2020-10-01T22:32:50+08:00">2020-10-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-20 23:43:06" itemprop="dateModified" datetime="2020-10-20T23:43:06+08:00">2020-10-20</time>
              </span>

          
            <span id="/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript运行机制" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/10/01/JavaScript/JavaScript%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h2><p>本文主要讲述 JS 运行机制的相关知识点，会从以下几个点分析：</p>
<ul>
<li>首先了解进程和线程的概念</li>
<li>浏览器有哪些进程，以 chrome 为例子；主要会讲述渲染进程的相关知识点；</li>
<li>通过对 JS 引擎调用栈、宿主环境及事件循环 Event Loop 来讲述 JS的运行机制；</li>
</ul>
<a id="more"></a>

<h2 id="经典面试题"><a href="#经典面试题" class="headerlink" title="经典面试题"></a>经典面试题</h2><p>谈谈 JavaScript 运行机制是怎样的？</p>
<h2 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>进程是指在系统中正在运行的一个应用程序，是系统进行资源分配和调度的一个独立单位，是 CPU 资源分配的最小单位</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>线程是操作系统能够进行运算调度的最小单位，大部分情况下，它被包含在进程之中，是进程中的实际运作单位，通俗来说，就是进程中的一个执行流。<br>一个进程中只有一个执行流，叫单线程，有多条执行流就是多线程。<br>同一进程中的多条线程将共享该进程中的内存空间，但每条线程又有自己的调用栈、本地存储、寄存器环境。</p>
<h2 id="JS单线程原因"><a href="#JS单线程原因" class="headerlink" title="JS单线程原因"></a>JS单线程原因</h2><p>JS 的单线程，与它的用途有关。作为浏览器脚本语言，JS 的主要用途是与用户互动，以及操作 DOM。这就决定了它只能是单线程，否则会带来很复杂的同步问题。<br>HTML5 的 Web Worker 标准，虽然允许 JS 脚本创建多个线程，但受控于主线程，且没办法操DOM</p>
<h2 id="浏览器进程-chrome"><a href="#浏览器进程-chrome" class="headerlink" title="浏览器进程(chrome)"></a>浏览器进程(chrome)</h2><p>浏览器包含以下主要进程：</p>
<ul>
<li>Browser主进程：只有一个进程，负责浏览器导航栏、前进、后退按钮及一些不可见的底层操作，比如网络请求和文件访问；</li>
<li>Plugin插件进程：负责控制一个网页用到的所有插件，如 Flash，Google翻译</li>
<li>GPU进程：全称 Graphics Processing Unit， 即图形处理器，主要用于处理图形相关</li>
<li>Extension扩展程序进程</li>
<li>Renderer渲染进程</li>
</ul>
<h3 id="Renderer渲染进程"><a href="#Renderer渲染进程" class="headerlink" title="Renderer渲染进程"></a>Renderer渲染进程</h3><p>浏览器渲染进程，广义上也称之为浏览器内核，主要是负责一个 tab 内关于网页呈现的所有事情，主要作用为页面渲染、脚本执行、事件处理等。<br>主要包含，事件触发线程、定时器触发线程、异步网络请求线程、GUI渲染线程、JS引擎线程；</p>
<ul>
<li>Question1: 为什么需要 JS 引擎?</li>
<li>Question2: 为什么建议 JS 脚本文件在页面底部引入?</li>
</ul>
<p>带着这两个问题，接下来先介绍下渲染进程中的一些主要线程</p>
<h4 id="事件触发线程"><a href="#事件触发线程" class="headerlink" title="事件触发线程"></a>事件触发线程</h4><p>负责控制事件循环，并且管理着一个任务队列，该线程属于浏览器而不是 JS 引擎</p>
<p>JS 执行遇到事件绑定及异步操作（定时器、Ajax请求等等），事件触发线程会将对应事件添加到对应的线程，等事件有了结果，便会被添加到待处理队列的队尾排队，等待 JS 引擎的处理</p>
<h4 id="定时器触发线程"><a href="#定时器触发线程" class="headerlink" title="定时器触发线程"></a>定时器触发线程</h4><p>用于对 setInterval 与 setTimeout 计时的线程<br>定时器的计时并不是由 JS 引擎计时，而是通过单独的线程来计时并触发定时，当计时完毕，会被添加到时间出发线程的任务队列中，等待 JS 引擎空闲后执行</p>
<blockquote>
<p>HTML5 标准规定，若 setTimeout 嵌套5层，则 setTimeout 最短时间间隔会被强制定为 4 毫秒，为了节电，对于那些不处于当前窗口的页面，浏览器会将时间间隔扩大到 1000 毫秒。另外，如果笔记本电脑处于电池供电状态，Chrome 和 IE 9 以上的版本，会将时间间隔切换到系统定时器，大约是16.6 毫秒。setInterval 最小间隔是 10 毫秒，参考<a href="https://dev.w3.org/html5/spec-LC/timers.html" target="_blank" rel="noopener">W3C HTML5标准</a>，<a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers" target="_blank" rel="noopener">HTML5标准</a></p>
</blockquote>
<h4 id="异步网络请求线程"><a href="#异步网络请求线程" class="headerlink" title="异步网络请求线程"></a>异步网络请求线程</h4><p>JS 遇到 http 请求时，会将异步请求事件加入到异步请求线程，待收到请求响应后，再将其回调函数添加到任务队列，待JS引擎线程来执行</p>
<h4 id="GUI渲染线程"><a href="#GUI渲染线程" class="headerlink" title="GUI渲染线程"></a>GUI渲染线程</h4><p>GUI，全称是 Graphical User Interface 图形用户界面，是指采用图形方式显示的计算机操作用户界面；主要作用：</p>
<ul>
<li>解析 HTML，生成 DOM 树</li>
<li>解析 CSS， 生成 CSSOM 规则树</li>
<li>结合 DOM 树与 CSSOM 树，生成渲染树 Rendering Tree</li>
<li>布局，计算出渲染树的布局</li>
<li>绘制，将渲染树绘制到屏幕</li>
</ul>
<p>当页面重绘(Repaint)和回流(Reflow)时，就会出发GUI线程的执行。<br>而解析 HTML、CSS等，主要是渲染引擎，即狭义上的浏览器内核，常见的浏览器内核有：</p>
<ul>
<li>Webkit (Safari、Chrome28之前的版本)</li>
<li>Trident (IE)</li>
<li>Gecko (Firefox)</li>
<li>Blink (Chrome28之后，Opera12.17之后)</li>
</ul>
<h4 id="JS引擎线程"><a href="#JS引擎线程" class="headerlink" title="JS引擎线程"></a>JS引擎线程</h4><p>JS 引擎并不是独立运行的，它运行在宿主环境中，如我们所熟知的浏览器、Node，如今也如今已经嵌入到了从机器人到电灯泡等各种各样的设备中。</p>
<h5 id="为什么需要-JS-引擎"><a href="#为什么需要-JS-引擎" class="headerlink" title="为什么需要 JS 引擎"></a>为什么需要 JS 引擎</h5><p>回答这个问题前，需要先了解解释型语言与编译型语言；</p>
<ul>
<li>解释型语言：是在运行的时候将程序翻译成机器语言；JavaScript/Java/Python</li>
<li>编译型语言：是先将源代码编译生成机器语言；C/C++</li>
</ul>
<p>JS 是<strong>解释型语言</strong>，在代码运行之前不会进行编译工作，将源码转换成字节码等中间代码或者是机器码，而是在执行的过程中实时编译，边编译边执行，而 JS 引擎就是做编译的，常见的 JS 引擎：</p>
<ul>
<li>V8 引擎(Chrome，Node，Opera)</li>
<li>SpiderMonkey(Firefox)</li>
<li>Nitro，也称之 JavaScriptCore (Safari)</li>
<li>Chakra(Edge、IE9+)</li>
<li>JScript(IE3~8)</li>
</ul>
<h5 id="主要工作"><a href="#主要工作" class="headerlink" title="主要工作"></a>主要工作</h5><p>JS 引擎线程负责解析 JS 脚本，执行代码；JS 引擎主要有两部分组成：</p>
<ul>
<li>内存堆：引用类型实际值、内存分配的地方</li>
<li>调用栈：基本类型存储、引用类型地址名存储、代码逻辑执行的地方</li>
</ul>
<p>调用栈(call stack)，也称执行栈，是一种拥有 LIFO（后进先出）数据结构的栈，被用来存储代码运行时创建的所有执行上下文，JS 代码执行时并不是一行一行的执行，而是一段一段的执行，而这”一段一段”指的是：<strong>执行上下文</strong>；<br><a href="https://www.ecma-international.org/ecma-262/6.0/#sec-execution-contexts" target="_blank" rel="noopener">执行上下文</a>：主要是指当前执行环境中的变量、函数声明，参数（arguments），作用域链，this 等信息，包含以下几种类型：</p>
<ul>
<li>全局执行上下文：默认的上下文，任何不在函数内部的代码都在全局上下文中，它会执行两件事：创建一个全局的 window 对象（浏览器的情况下），并且设置 this 的值等于这个全局对象(非严格模式下)。一个程序中只会有一个全局执行上下文</li>
<li>函数执行上下文：每当一个函数被调用时, 都会为该函数创建一个新的执行上下文，所以函数执行上下文会存在多个；执行顺序有调用栈决定；</li>
<li>eval 函数执行上下文：执行在 eval 函数内部的代码也会有它属于自己的执行上下文，但 eval 函数现在几乎没怎么使用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">first</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'进入 first'</span>)</span><br><span class="line">  second()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'first 执行完毕'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">second</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'进入 second'</span>)</span><br><span class="line">&#125;</span><br><span class="line">first()</span><br></pre></td></tr></table></figure>

<p><img src="/images/JavaScript/call_stack_demo.png" alt=""><br>在浏览器中，可以通过打开控制台，在 Sources tab上查看调用栈</p>
<p>若存在异步任务，则会将对应任务添加到对应的线程，经过事件循环后，再重新进入调用栈执行；如下图所示：<br><img height="600" src="/images/JavaScript/execute_flow_chart.png"/></p>
<h5 id="为什么建议脚本文件在页面底部引入"><a href="#为什么建议脚本文件在页面底部引入" class="headerlink" title="为什么建议脚本文件在页面底部引入"></a>为什么建议脚本文件在页面底部引入</h5><p>因为 GUI 线程与 JS 引擎线程是互斥的，所以当 JS 引擎执行时 GUI 线程会被挂起，导致页面渲染被阻塞，GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即被执行</p>
<h2 id="JavaScript-Runtime"><a href="#JavaScript-Runtime" class="headerlink" title="JavaScript Runtime"></a>JavaScript Runtime</h2><p>这里需要额外的讲述一个知识点，JavaScript Runtime，即 JavaScript 运行时。<br>Javascript 引擎是工作在一个宿主环境内的，如浏览器、Node； 这个环境提供了一些额外的功能(API)与JS 交互，所以这个宿主需要做两件事情：</p>
<ul>
<li>解析 JS 代码转换为机器码；</li>
<li>提供额外的 API 与 JS 交互；</li>
</ul>
<p>第一部分的工作由 JS 引擎处理，而第二部分的功能就由 JavaScript 运行时的环境提供；如在浏览器会提供web apis，window 对象、定时器等API；而在 Node 环境时，则会提供 fs 对象、require 对象、process对象等API；</p>
<h2 id="事件循环-Event-Loop"><a href="#事件循环-Event-Loop" class="headerlink" title="事件循环 Event Loop"></a>事件循环 Event Loop</h2><h3 id="上菜"><a href="#上菜" class="headerlink" title="上菜"></a>上菜</h3><p>先看一段代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-id">#outer</span> &#123;</span></span><br><span class="line">    width: 100px;</span><br><span class="line">    height: 100px;</span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#757575</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"outer"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> $outer = <span class="built_in">document</span>.querySelector(<span class="string">'#outer'</span>)</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  	<span class="built_in">console</span>.log(<span class="number">9</span>)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="number">2</span>)</span></span><br><span class="line">    &#125;, 17)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="number">3</span>)</span></span><br><span class="line">      resolve()</span><br><span class="line"><span class="javascript">    &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="number">4</span>)</span></span><br><span class="line"><span class="javascript">    &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="number">5</span>)</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    $outer.setAttribute(<span class="string">'data-random'</span>, <span class="built_in">Math</span>.random())</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span></span><br><span class="line"><span class="actionscript">    channel.port1.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(e.data)</span></span><br><span class="line">    &#125;</span><br><span class="line">    channel.port2.postMessage(6)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="number">7</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">await</span> foo()</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="number">10</span>)</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="number">8</span>)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">  <span class="comment">// 监听 DOM 改变</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="number">11</span>)</span></span><br><span class="line">  &#125;).observe($outer, &#123;</span><br><span class="line"><span class="actionscript">    attributes: <span class="literal">true</span></span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">  $outer.addEventListener(<span class="string">'click'</span>, handler)</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="同步任务与异步任务"><a href="#同步任务与异步任务" class="headerlink" title="同步任务与异步任务"></a>同步任务与异步任务</h3><p>虽然我们很早就可以编写异步的 JS 代码，但直到 ES6 的出现，JS才真正的有了异步的概念</p>
<p>JS任务广义上区分为同步与异步任务：</p>
<ul>
<li>同步任务：在主线程(JS引擎线程)排队执行的任务，会创建一个执行栈，按排队顺序执行，只有前一个任务执行完毕，才能执行后一个任务；</li>
<li>异步任务：不进入主线程，而是进入事件触发线程所管理的”任务队列”，待异步任务有了运行结果，就在任务队列之中放一个事件回调，等待执行；</li>
</ul>
<blockquote>
<p>Note: 任务队列也称之为消息队列或事件队列或回调队列，在本文统一为任务队列</p>
</blockquote>
<h3 id="代码执行机制"><a href="#代码执行机制" class="headerlink" title="代码执行机制"></a>代码执行机制</h3><ul>
<li>所有同步任务都在主线程上执行，形成一个执行栈</li>
<li>主线程之外，还存在一个”任务队列”。待异步任务有了运行结果，就在”任务队列”之中设置回调事件</li>
<li>主线程执行栈的所有同步任务执行完毕后，系统就会读取”任务队列”中的待执行的任务进入执行栈，开始执行</li>
<li>主线程不断的重复以上步骤</li>
</ul>
<p>图解：<br><img src="/images/JavaScript/execute.png" alt=""></p>
<h3 id="什么是事件循环"><a href="#什么是事件循环" class="headerlink" title="什么是事件循环"></a>什么是事件循环</h3><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#definitions-3" target="_blank" rel="noopener">HTML标准定义</a>如下：</p>
<blockquote>
<p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must use event loops as described in this section. Each agent has an associated event loop, which is unique to that agent</p>
</blockquote>
<p>Google翻译:</p>
<blockquote>
<p>为了协调事件，用户交互，脚本，渲染，网络等，用户代理必须使用本节中描述的事件循环。每个代理都有一个关联的事件循环，该循环对于该代理是唯一的</p>
</blockquote>
<p>所谓的用户代理，个人理解为宿主环境，如浏览器、Node。</p>
<p>HTML 中的标准晦涩难懂，所谓事件循环，简单来说，就是监视调用栈和任务队列，当调用栈的所有任务执行完毕，会将任务队列中的第一个任务添加到调用栈，并开始执行，如此反复就形成了事件循环。</p>
<h3 id="宏任务与微任务"><a href="#宏任务与微任务" class="headerlink" title="宏任务与微任务"></a>宏任务与微任务</h3><p>宏任务与微任务这两个专业术语，是在<a href="https://promisesaplus.com/#point-67" target="_blank" rel="noopener">Promise/A+的规范</a>中提到的；主要是为了对异步任务优先级的处理</p>
<h4 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h4><blockquote>
<p>An event loop has one or more task queues.<br>The microtask queue is not a task queue.<br>HTML 标准定义，一个 event loop 含有一个或多个任务队列 task queue，每一个 task 都来源于指定的任务源，规范中定义的任务源有：</p>
</blockquote>
<ul>
<li>DOM操作</li>
<li>用户交互(I/O 操作)</li>
<li>网络请求</li>
<li>history traversal，即调用浏览器history相关方法时</li>
</ul>
<p>在规范中的 <a href="https://html.spec.whatwg.org/#timers" target="_blank" rel="noopener">Timers 小节</a>中也提到，定时器 setTimeout、setInterval 也是作为任务执行；<br>postMessage、MessageChannel 及也会被作为任务源，参考规范的<a href="https://html.spec.whatwg.org/#message-ports" target="_blank" rel="noopener">Message Ports</a>一节</p>
<ul>
<li>setImmediate - Node</li>
</ul>
<p>这里需要额外的说明两点，UI rendering 及 requestAnimationFrame 常常被认为是宏任务，但是在 HTML 规范中并没有的说明，在事件循环模型的执行步骤中有提到，这两点都是在 Update the rendering 阶段执行的，所以从规范来说，这两个并不属于宏任务；</p>
<blockquote>
<p>Note: HTML 中并没有关于宏任务的定义，查阅许多资料，认为为了与微任务做区分，所以将事件循环中的任务也称之为宏任务。</p>
</blockquote>
<h4 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h4><blockquote>
<p>Each event loop has a microtask queue, which is a queue of microtasks, initially empty. A microtask is a colloquial way of referring to a task that was created via the queue a microtask algorithm.<br>Each event loop has a performing a microtask checkpoint boolean, which is initially false. It is used to prevent reentrant invocation of the perform a microtask checkpoint algorithm.</p>
</blockquote>
<p>HTML标准定义，一个 event loop 存在一个微任务队列，但是并没有准确的定义有哪些是 microtask 的任务源，通常认为微任务的任务源有：</p>
<ul>
<li>promise.then/catch/finally</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask" target="_blank" rel="noopener">queueMicrotask</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener">MutationObserver</a>(用于监听 DOM 的改变)</li>
<li>process.nextTick - Node</li>
</ul>
<blockquote>
<p>Note: 在 <a href="https://promisesaplus.com/#notes" target="_blank" rel="noopener">Promises/A+规范</a> 中有提到，promise 即可属于 macro-task，也可以属于 micro-task，但通常认为属于微任务，所以早期 Firefox 及 Safari 版本中有些是属于 macro-task，而在最新版本后，统一都属于 micro-task</p>
</blockquote>
<p>在 ECMAScript 规范中的<a href="https://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues" target="_blank" rel="noopener">Job</a>概念与微任务的概念相类似。</p>
<h3 id="事件循环模型"><a href="#事件循环模型" class="headerlink" title="事件循环模型"></a>事件循环模型</h3><p>HTML标准定义了 Event Loop 的<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener">循环过程</a>，根据标准，总结出以下步骤：</p>
<ol>
<li>在任务队列 task queue 中选择最早的任务 task；若无可选的任务，则跳到下边的 Microtasks 步骤；</li>
<li>将步骤一选择的任务 task 设置为正在运行的任务 task；</li>
<li>运行该任务 task，即运行该回调事件；</li>
<li>将事件循环的当前正在运行的任务设置为 null，并将该任务 task 从任务队列 task queue 中移除；</li>
<li>Microtasks: 执行<a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint" target="_blank" rel="noopener">microtasks 任务检查点</a>，即执行微任务队列 microtask queue 里的任务；<ol>
<li>检查微任务检查点 microtask checkpoint，若为 true 则返回；</li>
<li>若 microtask checkpoint 为 false，则设置为 true；</li>
<li>在微任务队列中选择最早的微任务，若无可选微任务，则微任务队列执行结束；</li>
<li>将选择后的微任务设置为当前正在运行的微任务；</li>
<li>运行所选择微任务；</li>
<li>设置事件循环当前正在任务为 null，并从微任务队列中移除；</li>
<li>返回第 3 步，继续执行下一个微任务；</li>
<li>所有微任务执行完毕，将微任务检查点设置为 false；</li>
</ol>
</li>
<li>Update the rendering：GUI 渲染页面</li>
<li>返回步骤一，继续执行下一个宏任务</li>
</ol>
<blockquote>
<p>Note: 当然，在执行任务的过程中，若再次遇到宏任务或者微任务，则会添加到对应任务队列的尾部<br>所以事件循环的执行步骤大致可以归结为：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">宏任务 &#x3D;&gt; 微任务 &#x3D;&gt; GUI 渲染 &#x3D;&gt; 宏任务 &#x3D;&gt; 微任务 &#x3D;&gt; GUI 渲染 ...</span><br></pre></td></tr></table></figure>
<p>图解事件循环执行步骤：<br><img height="400" src="/images/JavaScript/macro-micro.png"></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>demo1：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">  resolve()</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>demo2：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>)</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>)</span><br><span class="line">  &#125;, <span class="number">500</span>)</span><br><span class="line">  resolve()</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">6</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>

<p>demo3：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animation</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">requestAnimationFrame(animation)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">5</span>)</span><br><span class="line">&#125;).observe(<span class="built_in">document</span>.body, &#123;</span><br><span class="line">  attributes: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.style = <span class="string">'background: blue;'</span></span><br><span class="line"></span><br><span class="line">queueMicrotask(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">6</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line"></span><br><span class="line">channel.port1.postMessage(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">channel.port2.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Node事件循环"><a href="#Node事件循环" class="headerlink" title="Node事件循环"></a>Node事件循环</h2><p>node的事件循环其实跟浏览器差不多，也是先执行宏任务再执行微任务，只不过node的事件循环有分六个阶段；如下图(图片来之官网)所示：<br><img src="/images/JavaScript/node_event_loop.png" alt=""></p>
<ul>
<li>timers:：该阶段执行 setTimeout 及 setInterval 的毁掉回调</li>
<li>pending callbacks：该阶段执行延迟到下一个循环迭代的I/O回调</li>
<li>idle, prepare：仅 node 内部调用</li>
<li>poll：该阶段检测新的I/O事件;执行与I/O相关的回调(除close回调、由定时器的回调和setimmediation()之外的所有回调);节点将在适当的时候阻塞</li>
<li>check：该阶段执行 setImmediate 的回掉</li>
<li>close callbacks：执行一些 close 事件的回调，如 <code>socket.on(&#39;close&#39;, ...)</code></li>
</ul>
<p>需要注意一点，process.nextTick在微任务阶段执行时，都会优先执行。更详细的讲解请参考<a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener">官方文档</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://html.spec.whatwg.org/" target="_blank" rel="noopener">W3C HTML标准</a></li>
<li><a href="https://www.ecma-international.org/ecma-262/6.0/" target="_blank" rel="noopener">ECMAScript® 2015 Language Specification</a></li>
<li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Tasks, microtasks, queues and schedules</a></li>
<li><a href="https://vimeo.com/96425312" target="_blank" rel="noopener">Philip Roberts: Help, I’m stuck in an event-loop.</a></li>
<li><a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ&t=17s" target="_blank" rel="noopener">菲利普·罗伯茨：到底什么是Event Loop呢？</a></li>
<li><a href="https://stackoverflow.com/questions/25915634/difference-between-microtask-and-macrotask-within-an-event-loop-context" target="_blank" rel="noopener">Difference between microtask and macrotask within an event loop context</a></li>
<li><a href="https://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener">JavaScript 运行机制详解：再谈Event Loop</a></li>
<li><a href="https://github.com/aooy/blog/issues/5" target="_blank" rel="noopener">从event loop规范探究javaScript异步及浏览器更新渲染时机</a></li>
<li><a href="https://juejin.im/post/6844904050543034376#heading-19" target="_blank" rel="noopener">「硬核JS」一次搞懂JS运行机制</a></li>
<li><a href="https://javascript.info/event-loop" target="_blank" rel="noopener">Event loop: microtasks and macrotasks</a></li>
<li><a href="https://blog.sessionstack.com/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5" target="_blank" rel="noopener">How JavaScript works: Event loop and the rise of Async programming + 5 ways to better coding with async/await</a></li>
<li><a href="https://promisesaplus.com/#notes" target="_blank" rel="noopener">Promises/A+规范</a></li>
<li><a href="https://www.geeksforgeeks.org/what-are-the-microtask-and-macrotask-within-an-event-loop-in-javascript/" target="_blank" rel="noopener">What are the microtask and macrotask within an event loop in JavaScript ?</a></li>
<li><a href="https://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues" target="_blank" rel="noopener">ECMAScript Jobs and Job Queues</a></li>
<li><a href="https://www.cnblogs.com/jiasm/p/9482443.html" target="_blank" rel="noopener">微任务、宏任务与Event-Loop</a></li>
<li><a href="https://ginobilee.github.io/blog/2019/02/01/requestAnimationFrame%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AE%8F%E4%BB%BB%E5%8A%A1%E4%B9%88/" target="_blank" rel="noopener">requestAnimationFrame是一个宏任务么</a></li>
<li><a href="https://www.infoq.cn/article/CS9-WZQlNR5h05HHDo1b" target="_blank" rel="noopener">史上最全！图解浏览器的工作原理</a></li>
<li><a href="https://juejin.im/post/6844903692894732295" target="_blank" rel="noopener">[译] 现代浏览器内部揭秘（第三部分）</a></li>
<li><a href="https://stackoverflow.com/questions/29027845/what-is-the-difference-between-javascript-engine-and-javascript-runtime-environm" target="_blank" rel="noopener">What is the difference between JavaScript Engine and JavaScript Runtime Environment</a></li>
<li>你不知道的JavaScript(中卷)</li>
<li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener">The Node.js Event Loop, Timers, and <code>process.nextTick()</code></a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/30/JavaScript/DOM%E4%BA%8B%E4%BB%B6%E5%AF%B9%E8%B1%A1/" rel="prev" title="DOM事件对象">
      <i class="fa fa-chevron-left"></i> DOM事件对象
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#导读"><span class="nav-number">1.</span> <span class="nav-text">导读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#经典面试题"><span class="nav-number">2.</span> <span class="nav-text">经典面试题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进程和线程"><span class="nav-number">3.</span> <span class="nav-text">进程和线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程"><span class="nav-number">3.1.</span> <span class="nav-text">进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程"><span class="nav-number">3.2.</span> <span class="nav-text">线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JS单线程原因"><span class="nav-number">4.</span> <span class="nav-text">JS单线程原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器进程-chrome"><span class="nav-number">5.</span> <span class="nav-text">浏览器进程(chrome)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Renderer渲染进程"><span class="nav-number">5.1.</span> <span class="nav-text">Renderer渲染进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#事件触发线程"><span class="nav-number">5.1.1.</span> <span class="nav-text">事件触发线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定时器触发线程"><span class="nav-number">5.1.2.</span> <span class="nav-text">定时器触发线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步网络请求线程"><span class="nav-number">5.1.3.</span> <span class="nav-text">异步网络请求线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GUI渲染线程"><span class="nav-number">5.1.4.</span> <span class="nav-text">GUI渲染线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JS引擎线程"><span class="nav-number">5.1.5.</span> <span class="nav-text">JS引擎线程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么需要-JS-引擎"><span class="nav-number">5.1.5.1.</span> <span class="nav-text">为什么需要 JS 引擎</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#主要工作"><span class="nav-number">5.1.5.2.</span> <span class="nav-text">主要工作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么建议脚本文件在页面底部引入"><span class="nav-number">5.1.5.3.</span> <span class="nav-text">为什么建议脚本文件在页面底部引入</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScript-Runtime"><span class="nav-number">6.</span> <span class="nav-text">JavaScript Runtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件循环-Event-Loop"><span class="nav-number">7.</span> <span class="nav-text">事件循环 Event Loop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#上菜"><span class="nav-number">7.1.</span> <span class="nav-text">上菜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步任务与异步任务"><span class="nav-number">7.2.</span> <span class="nav-text">同步任务与异步任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码执行机制"><span class="nav-number">7.3.</span> <span class="nav-text">代码执行机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是事件循环"><span class="nav-number">7.4.</span> <span class="nav-text">什么是事件循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#宏任务与微任务"><span class="nav-number">7.5.</span> <span class="nav-text">宏任务与微任务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#宏任务"><span class="nav-number">7.5.1.</span> <span class="nav-text">宏任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微任务"><span class="nav-number">7.5.2.</span> <span class="nav-text">微任务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件循环模型"><span class="nav-number">7.6.</span> <span class="nav-text">事件循环模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">7.7.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node事件循环"><span class="nav-number">8.</span> <span class="nav-text">Node事件循环</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zed"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">zed</p>
  <div class="site-description" itemprop="description">欲望提升热忱，毅力磨平高山</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CBCzed" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CBCzed" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zed</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdnjs.cloudflare.com/ajax/libs/valine/1.3.10/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: false,
      appId: 'zD49AovTAtNDF87e6yNmeUp4-gzGzoHsz',
      appKey: 'IxyYcjJQjBSgU9zQgI21lGFC',
      placeholder: "请留下您宝贵的意见",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: true,
      lang: 'zh-cn' || 'zh-cn',
      path: location.pathname,
      recordIP: false,
      serverURLs: ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
